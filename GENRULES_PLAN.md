# Rule Auto-Generation Implementation Plan

**Branch**: `feature/autogen-rules-en16931`
**Issue**: #27
**Goal**: Auto-generate rules.go from official EN 16931 schematron specifications

## Context

The rule registry refactoring (PR #26) created a centralized `Rule` struct:
```go
type Rule struct {
    Code        string   // "BR-1", "BR-S-8", etc.
    Fields      []string // ["BT-24"], ["BT-117", "BG-23"], etc.
    Description string   // Official EN 16931 text
}
```

Currently, all 204 rules are manually transcribed in the main package. This plan automates generation from official sources **into a separate `rules` package** for better organization and separation of concerns.

## Package Structure

Rules will be generated into a separate package:

```
einvoice/
├── rules/              # NEW: Generated rules package
│   ├── en16931.go      # Generated EN 16931 rules
│   └── doc.go          # Package documentation
├── cmd/
│   └── genrules/       # Rule generation tool
│       └── main.go
├── validation.go       # Import rules package
├── check*.go          # Import rules package
└── ...
```

**Benefits of separate package**:
- Clear separation between generated and hand-written code
- Easy to add other rule sets (PINT, XRechnung) as separate files
- Cleaner imports: `import "github.com/speedata/einvoice/rules"`
- Future-proof for multiple validation standards

## Source Files

### Primary Source
- **Repository**: https://github.com/ConnectingEurope/eInvoicing-EN16931
- **Version**: v1.3.14.1 (April 22, 2025)
- **License**: EUPL v1.2

### Key Files
1. **Abstract Pattern** (rule descriptions):
   - Path: `cii/schematron/abstract/EN16931-CII-model.sch`
   - URL: https://raw.githubusercontent.com/ConnectingEurope/eInvoicing-EN16931/master/cii/schematron/abstract/EN16931-CII-model.sch
   - Contains: 203 business rules with human-readable descriptions

2. **Concrete Binding** (XPath expressions, future use):
   - Path: `cii/schematron/CII/EN16931-CII-model.sch`
   - Contains: CII-specific XPath test expressions

## XML Structure

### Input Format
```xml
<pattern xmlns="http://purl.oclc.org/dsdl/schematron" abstract="true" id="EN16931">
  <rule context="$ContextName">
    <assert test="$BR-XX" flag="fatal" id="BR-XX">
      [BR-XX]-Description text with field references (BT-YY) (BG-ZZ).
    </assert>
  </rule>
</pattern>
```

### Example Rules
```xml
<!-- Simple rule with one field -->
<assert test="$BR-01" flag="fatal" id="BR-01">
  [BR-01]-An Invoice shall have a Specification identifier (BT-24).
</assert>

<!-- Complex rule with multiple fields -->
<assert test="$BR-S-08" flag="fatal" id="BR-S-08">
  [BR-S-08]-For each different value of VAT category rate (BT-119) where
  the VAT category code (BT-118) is "Standard rated", the VAT category
  taxable amount (BT-116) in a VAT breakdown (BG-23) shall equal...
</assert>
```

## Data Extraction

### 1. Rule Code
- **Source**: XML `id` attribute
- **Method**: Direct read
- **Examples**: "BR-01", "BR-S-08", "BR-CO-14"

### 2. Description
- **Source**: XML text content
- **Processing**:
  1. Strip `[BR-XX]-` prefix
  2. Normalize whitespace (collapse multiple spaces)
  3. Trim leading/trailing whitespace
- **Example Input**: `[BR-01]-An Invoice shall have a Specification identifier (BT-24).`
- **Example Output**: `An Invoice shall have a Specification identifier (BT-24).`

### 3. Fields (BT-/BG- Identifiers)
- **Source**: Description text
- **Regex Pattern**: `\(B[TG]-\d+\)`
- **Processing**:
  1. Find all matches: `(BT-24)`, `(BG-23)`, etc.
  2. Remove parentheses: `BT-24`, `BG-23`
  3. Deduplicate (preserve first occurrence order)
  4. Sort alphabetically for consistency
- **Example**:
  - Input: `"...amount (BT-117) in breakdown (BG-23) where code (BT-118)..."`
  - Output: `[]string{"BG-23", "BT-117", "BT-118"}`

## Go Identifier Generation

### Conversion Rules
| Rule Code | Go Identifier | Pattern |
|-----------|---------------|---------|
| BR-1      | BR1           | Remove single dash |
| BR-01     | BR1           | Remove leading zero and dash |
| BR-S-8    | BRS8          | Remove all dashes, keep letters |
| BR-CO-14  | BRCO14        | Remove all dashes |
| BR-AE-10  | BRAE10        | Remove all dashes |
| BR-DEC-23 | BRDEC23       | Remove all dashes |

### Algorithm
```go
func ruleCodeToIdentifier(code string) string {
    // Remove "BR-" prefix: "BR-S-8" → "S-8"
    s := strings.TrimPrefix(code, "BR-")

    // Remove all dashes: "S-8" → "S8"
    s = strings.ReplaceAll(s, "-", "")

    // Remove leading zeros: "01" → "1"
    s = strings.TrimLeft(s, "0")

    // Prepend BR: "S8" → "BRS8"
    return "BR" + s
}
```

## Output Format

### Generated File Structure (rules/en16931.go)
```go
// Code generated by genrules from EN16931-CII-model.sch; DO NOT EDIT.
// Source: https://github.com/ConnectingEurope/eInvoicing-EN16931
// Version: v1.3.14.1
// Generated: 2025-10-07T15:30:00Z

package rules

// Rule represents a business rule from the EN 16931 specification.
type Rule struct {
    Code        string
    Fields      []string
    Description string
}

var (
    // Core Business Rules (BR-1 to BR-66)

    BR1 = Rule{
        Code:        "BR-01",
        Fields:      []string{"BT-24"},
        Description: "An Invoice shall have a Specification identifier (BT-24).",
    }

    BR2 = Rule{
        Code:        "BR-02",
        Fields:      []string{"BT-1"},
        Description: "An Invoice shall have an Invoice number (BT-1).",
    }

    // ... more rules ...

    // Calculation Rules (BR-CO-*)

    BRCO10 = Rule{
        Code:        "BR-CO-10",
        Fields:      []string{"BT-106", "BT-131"},
        Description: "Sum of Invoice line net amount (BT-106) = Σ Invoice line net amount (BT-131).",
    }

    // ... more rules ...

    // Standard VAT Rules (BR-S-*)

    BRS8 = Rule{
        Code:        "BR-S-08",
        Fields:      []string{"BG-23", "BT-95", "BT-96", "BT-99", "BT-102", "BT-116", "BT-118", "BT-119", "BT-131", "BT-151", "BT-92"},
        Description: "For each different value of VAT category rate (BT-119) where the VAT category code (BT-118) is \"Standard rated\", the VAT category taxable amount (BT-116) in a VAT breakdown (BG-23) shall equal the sum of Invoice line net amounts (BT-131) plus the sum of document level charge amounts (BT-99) minus the sum of document level allowance amounts (BT-92) where the VAT category code (BT-151, BT-102, BT-95) is \"Standard rated\" and the VAT rate (BT-152, BT-103, BT-96) equals the VAT category rate (BT-119).",
    }

    // ... all 203 rules ...
)
```

### Usage in Main Package
```go
package einvoice

import "github.com/speedata/einvoice/rules"

func (inv *Invoice) checkBR1() {
    if inv.SpecificationIdentifier == "" {
        inv.addViolation(rules.BR1, "Missing specification identifier")
    }
}

func (e *ValidationError) HasRule(rule rules.Rule) bool {
    for _, v := range e.violations {
        if v.Rule.Code == rule.Code {
            return true
        }
    }
    return false
}
```

## Tool Implementation

### Command Line Interface
```bash
# Basic usage (outputs to rules/en16931.go)
go run ./cmd/genrules \
  -source abstract/EN16931-CII-model.sch \
  -output rules/en16931.go

# With version tracking
go run ./cmd/genrules \
  -source abstract/EN16931-CII-model.sch \
  -version v1.3.14.1 \
  -package rules \
  -output rules/en16931.go

# From URL (recommended)
go run ./cmd/genrules \
  -source https://raw.githubusercontent.com/ConnectingEurope/eInvoicing-EN16931/master/cii/schematron/abstract/EN16931-CII-model.sch \
  -version v1.3.14.1 \
  -package rules \
  -output rules/en16931.go
```

### Flags
- `--source`: Schematron file path or URL (required)
- `--output`: Output file path (default: "rules/en16931.go")
- `--package`: Target package name (default: "rules")
- `--version`: Source file version for tracking (optional)
- `--help`: Show usage information

## Validation Strategy

### Phase 1: Prototype Validation
Generate first 10 rules (BR-1 through BR-10) and manually compare with current rules.go:
- ✓ Code matches
- ✓ Description matches official spec
- ✓ Fields array is complete

### Phase 2: Full Generation
Generate all 203 rules and validate:
- ✓ No duplicate identifiers
- ✓ All rule codes from schematron are present
- ✓ Fields arrays match or improve upon manual version
- ✓ Generated code compiles without errors
- ✓ All tests pass

### Phase 3: Integration
- ✓ Add `//go:generate` directive
- ✓ Update CLAUDE.md with generation instructions
- ✓ CI check that generated file matches committed file

## Testing Checklist

- [ ] Parse schematron XML without errors
- [ ] Extract all 203 rules
- [ ] Rule code extraction correct (BR-01, BR-S-08, etc.)
- [ ] Description cleaning works (prefix removed, whitespace normalized)
- [ ] Field extraction regex captures all BT-/BG- references
- [ ] Field deduplication works
- [ ] Go identifier generation handles all patterns
- [ ] Generated code is valid Go (gofmt passes)
- [ ] Generated code compiles
- [ ] Existing tests pass with generated rules
- [ ] Generated file is deterministic (same input = same output)

## Edge Cases to Handle

1. **Multiple spaces in description**: Collapse to single space
2. **Line breaks in description**: Replace with single space
3. **Duplicate field references**: Keep only first occurrence
4. **Fields in different order**: Sort alphabetically
5. **Leading zeros in rule codes**: BR-01 → BR1 (not BR01)
6. **Complex rule codes**: BR-DEC-23 → BRDEC23
7. **Quoted text in descriptions**: Preserve quotes
8. **Special characters**: Preserve in description, escape in Go string

## Known Discrepancies

Some manually-created rules may have incomplete Fields arrays. Generated version should be more comprehensive by extracting ALL field references from official descriptions.

Example:
- **Manual**: BR-28 has `Fields: []string{"BT-148"}`
- **Official Spec**: Only mentions BT-148
- **Generated**: Should match official spec

## Files to Create/Modify

### New Files
- `rules/` - New package directory
- `rules/en16931.go` - Generated EN 16931 rules
- `rules/doc.go` - Package documentation
- `cmd/genrules/main.go` - Main generator tool
- `cmd/genrules/README.md` - Tool documentation

### Modified Files
- `validation.go` - Import rules package, update Rule references
- `check.go` - Import rules package, update addViolation calls
- `check_*.go` - Import rules package, update all rule references
- `validation_test.go` - Update test fixtures to use rules.BR*
- `check_test.go` - Update test expectations for rules package
- `CLAUDE.md` - Add section on rule generation and package structure
- `.gitignore` - Ignore temporary test output files

### Files to Migrate/Remove (After Validation)
- `rules.go` - Existing manual rules, will be replaced by rules/en16931.go
  - Option 1: Delete after successful migration
  - Option 2: Keep temporarily with deprecation notice
  - Option 3: Move Rule type definition to separate file if needed elsewhere

## Dependencies

All standard library:
- `encoding/xml` - Parse schematron XML
- `text/template` - Generate Go code
- `regexp` - Extract field references
- `os/exec` - Run gofmt
- `flag` - CLI argument parsing
- `io` - File operations
- `net/http` - Download from URL (optional)

## Success Criteria

1. ✅ Tool generates valid Go code
2. ✅ All 203 rules extracted from official spec
3. ✅ Generated rules match or improve manual version
4. ✅ All existing tests pass
5. ✅ `go generate` workflow integrated
6. ✅ Documentation complete

## Future Enhancements (Out of Scope)

- Parse concrete binding file for XPath expressions
- Generate validation code automatically from XPath
- Support multiple schematron sources (PINT, XRechnung)
- Web UI for browsing rules
- Diff tool for comparing spec versions

## References

- Issue #27: https://github.com/speedata/einvoice/issues/27
- EN 16931 Repo: https://github.com/ConnectingEurope/eInvoicing-EN16931
- Schematron Spec: https://schematron.com/
- PR #26: Rule registry refactoring
